<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <title>Westports RTC</title>
    <style type="text/css">
        #user_placeholder {
            display: none;
        }
    </style>
  </head>
  <body>
      <div class="container">
          <div class="row">
              <p>Status: <span id="socket_status">Not connected..</span></p>
          </div>
          <div class="row">
              <div class="form-row">
                <div class="col">
                    <input type="text" class="form-control" placeholder="Name" id="username" readonly>
                </div>
                <div class="col">
                  <input type="text" class="form-control" placeholder="Message" id="msg_content">
                </div>
                <div class="col"><button type="button" class="btn btn-primary" id="send_btn">Send</button></div>
              </div>
          </div>
          <div class="row">
            <div class="form-row">
                <div class="col col-lg-6">
                  <textarea class="form-control" rows="10" id="msg" readonly></textarea>
                </div>
                <div class="col col-sm-2">
                    <textarea class="form-control" rows="10" id="user-list" readonly></textarea>
                    <div id="user_placeholder"></div>
                </div>
            </div>
          </div>
      </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script type="text/javascript">
        var socket;
        var channel = "test";
        var room = "test";
        var userid = Math.random();
        var userlist = [];
        
        $(document).ready(function(){
            var url_string = document.location.href;
            var url = new URL(url_string);
            var c = url.searchParams.get("u");
            var d = url.searchParams.get("ch");
            var e = url.searchParams.get("r");
            if(c!="" && d!="" && e!="") {
                userid = c; $("#username").val(userid); channel = d; room = e;
            }

            socket = new WebSocket("wss://connect.websocket.in/"+channel+"?room_id="+room);
            
            socket.onopen = function(ev) { // connection is open   
                $("#socket_status").html("Connected to "+channel+" ("+room+")");  
                send_identity();
                console.log("websocket connected..");
            }
            
            socket.onmessage = function(ev) {
                try {
                    let content = JSON.parse(ev.data);
                    if(content.type == "msg") {
                        $("#msg").append(get_date_str_jscript(get_dtime())+" - "+content.sender+": "+content.msg+"\n");
                        var $textarea = $('#msg');
                        $textarea.scrollTop($textarea[0].scrollHeight);
                        console.log(ev.data);
                    }
                    if(content.type == "ident") {
                        if($("span#user_"+content.sender).length<=0) {
                            $("#user_placeholder").append("<span id='user_"+content.sender+"'>"+content.sender+"</span>");
                            $("#user-list").html("");
                            $("#user_placeholder span").each(function(){
                                $("#user-list").append($(this).text()+"\n");
                            });                            
                            var $textarea = $('#user-list');
                            $textarea.scrollTop($textarea[0].scrollHeight);
                            send_identity();
                        }
                    }
                    if(content.type == "quit") {
                        if($("span#user_"+content.sender).length>0) {
                            $("span#user_"+content.sender).remove();
                            $("#user-list").html("");
                            $("#user_placeholder span").each(function(){
                                $("#user-list").append($(this).text()+"\n");
                            });                            
                            var $textarea = $('#user-list');
                            $textarea.scrollTop($textarea[0].scrollHeight);
                        }
                    }
                } catch(err) {}
            }
            
            socket.onerror = function(ev){
                $("#socket_status").html("Connection Error!"); 
                console.log("websocket error"+ev)
            }; 
            socket.onclose = function(ev){ 
                let msg = {"type":"quit", "sender":userid};
                socket.send(JSON.stringify(msg));
                $("#socket_status").html("Connection Error!"); 
                console.log("websocket close"+ev)
            };
            
            $("#send_btn").click(function(){
                let msg = {"type":"msg", "sender":userid, "msg":$("#msg_content").val()};
                socket.send(JSON.stringify(msg));
                $("#msg").append(get_date_str_jscript(get_dtime())+" - You: "+$("#msg_content").val()+"\n");
                var $textarea = $('#msg');
                $textarea.scrollTop($textarea[0].scrollHeight);
            });
            
            //broadcast own id
            
        });
        
        function send_identity() {
            let msg = {"type":"ident", "sender":userid};
            socket.send(JSON.stringify(msg));
        }
        
        function get_dtime() {
            let dt = new Date();
            return dt;
        }
        
        function get_date_str_jscript(d) {
            var now = d;
            var dt = now.getDate();
            dt = (String(dt).length<2)? String("0") + String(dt) : dt;
            var hrs = now.getHours();
            hrs = (String(hrs).length<2)? String("0") + String(hrs) : hrs;
            var min = now.getMinutes();
            min = (String(min).length<2)? String("0") + String(min) : min;
            var sec = now.getSeconds();
            sec = (String(sec).length<2)? String("0") + String(sec) : sec;
            var mth = (now.getMonth() + 1);
            mth = (String(mth).length<2)? String("0") + String(mth) : mth;
            //return now.getFullYear()+'-'+String(mth)+'-'+String(dt)+' '+String(hrs)+':'+String(min)+':'+String(sec);
            return String(hrs)+':'+String(min)+':'+String(sec);
            //return now.getHours()+':'+String(min)+':'+String(sec);
        }
    </script>
  </body>
</html>
